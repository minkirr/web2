<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Picker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        input, button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h3>Выберите время:</h3>
    <input type="time" id="timeInput">
    <button id="sendBtn">Отправить</button>
    <div id="status"></div>

    <script>
        function showAlert(message, isError = false) {
            alert((isError ? '❌ ОШИБКА: ' : 'ℹ️ ') + message);
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.background = isError ? '#ffdddd' : '#ddffdd';
            statusEl.style.color = isError ? 'red' : 'green';
        }

        function debugLog(message) {
            console.log('[DEBUG]', message);
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                debugLog('Инициализация приложения');
                
                const tg = window.Telegram?.WebApp;
                if (!tg) {
                    throw new Error('Это приложение работает только внутри Telegram!');
                }

                debugLog('Telegram WebApp доступен');
                debugLog('Платформа: ' + tg.platform);
                debugLog('InitData: ' + JSON.stringify(tg.initData));

                tg.expand();
                tg.enableClosingConfirmation();
                debugLog('WebApp расширен и настроен');

                document.getElementById('sendBtn').addEventListener('click', () => {
                    try {
                        debugLog('Кнопка "Отправить" нажата');
                        
                        const timeInput = document.getElementById('timeInput');
                        if (!timeInput.value) {
                            throw new Error('Пожалуйста, выберите время!');
                        }

                        const payload = {
                            time: timeInput.value,
                            userId: tg.initDataUnsafe?.user?.id
                        };
                        const dataString = JSON.stringify(payload);
                        debugLog('Отправляемые данные: ' + dataString);

                        showAlert('Попытка отправки данных...');
                        
                        tg.sendData(dataString);
                        debugLog('Метод sendData вызван успешно');
                        
                        showAlert('Данные успешно отправлены!');
                        
                        setTimeout(() => {
                            try {
                                tg.close();
                                debugLog('WebApp закрыт');
                            } catch (e) {
                                showAlert('Ошибка при закрытии: ' + e.message, true);
                            }
                        }, 1000);

                    } catch (e) {
                        showAlert(e.message, true);
                        debugLog('Ошибка: ' + e.stack);
                    }
                });

                debugLog('Приложение готово к работе');

            } catch (e) {
                showAlert('Критическая ошибка инициализации: ' + e.message, true);
                debugLog('FATAL: ' + e.stack);
            }
        });
    </script>
</body>
</html>